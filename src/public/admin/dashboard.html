<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SnapList Admin Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="icon" type="image/png" href="/static/img/logo.png">
  <!-- Chart.js Library -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- DateRangePicker for time filtering -->
  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />
  <script type="text/javascript" src="https://cdn.jsdelivr.net/jquery/latest/jquery.min.js"></script>
  <script type="text/javascript" src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
  <style>
    :root {
      --primary-color: #FF6A00;
      --primary-light: #FFF0E6;
      --primary-dark: #E56000;
      --text-primary: #1D1D1D;
      --text-secondary: #666666;
      --background-color: #F9F9FB;
      --card-background: #FFFFFF;
      --border-color: #E5E5E5;
      --shadow-color: rgba(0, 0, 0, 0.05);
      --success-color: #34C759;
      --warning-color: #FF9500;
      --danger-color: #FF3B30;
      --sidebar-width: 240px;
    }
    
    @media (prefers-color-scheme: dark) {
      :root {
        --primary-color: #FF6A00;
        --primary-light: #2C1A0D;
        --primary-dark: #FF8A3F;
        --text-primary: #FFFFFF;
        --text-secondary: #AAAAAA;
        --background-color: #1A1A1A;
        --card-background: #222222;
        --border-color: #333333;
        --shadow-color: rgba(0, 0, 0, 0.2);
      }
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Inter', sans-serif;
    }
    
    body {
      background-color: var(--background-color);
      color: var(--text-primary);
      display: flex;
      min-height: 100vh;
    }
    
    /* Sidebar Styles */
    .sidebar {
      width: var(--sidebar-width);
      background-color: var(--card-background);
      border-right: 1px solid var(--border-color);
      padding: 24px 0;
      height: 100vh;
      position: fixed;
      top: 0;
      left: 0;
      overflow-y: auto;
    }
    
    .sidebar-header {
      padding: 0 20px 20px;
      margin-bottom: 20px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      align-items: center;
    }
    
    .sidebar-header img {
      width: 32px;
      height: 32px;
      margin-right: 12px;
    }
    
    .sidebar-header h1 {
      font-size: 18px;
      font-weight: 700;
      color: var(--primary-color);
    }
    
    .nav-section {
      margin-bottom: 16px;
    }
    
    .nav-section-title {
      text-transform: uppercase;
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      padding: 8px 20px;
      margin-bottom: 4px;
    }
    
    .nav-item {
      display: flex;
      align-items: center;
      padding: 10px 20px;
      color: var(--text-primary);
      text-decoration: none;
      font-size: 14px;
      font-weight: 500;
      border-left: 3px solid transparent;
      transition: all 0.2s;
    }
    
    .nav-item.active {
      background-color: var(--primary-light);
      color: var(--primary-color);
      border-left-color: var(--primary-color);
    }
    
    .nav-item:hover:not(.active) {
      background-color: rgba(0, 0, 0, 0.03);
    }
    
    .nav-item-icon {
      width: 18px;
      height: 18px;
      margin-right: 12px;
      opacity: 0.8;
    }
    
    .sidebar-footer {
      padding: 16px 20px;
      border-top: 1px solid var(--border-color);
      margin-top: auto;
    }
    
    .logout-button {
      padding: 8px 12px;
      background-color: var(--background-color);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    
    .logout-button:hover {
      background-color: var(--danger-color);
      color: white;
      border-color: var(--danger-color);
    }
    
    /* Main Content Styles */
    .main-content {
      flex: 1;
      margin-left: var(--sidebar-width);
      padding: 24px;
    }
    
    .page-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 24px;
    }
    
    .page-title {
      font-size: 24px;
      font-weight: 700;
    }
    
    /* Stats Cards */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 20px;
      margin-bottom: 24px;
    }
    
    .stat-card {
      background-color: var(--card-background);
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 12px var(--shadow-color);
      display: flex;
      flex-direction: column;
    }
    
    .stat-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }
    
    .stat-value {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 12px;
    }
    
    .stat-change {
      display: flex;
      align-items: center;
      font-size: 12px;
      font-weight: 500;
    }
    
    .stat-change.positive {
      color: var(--success-color);
    }
    
    .stat-change.negative {
      color: var(--danger-color);
    }
    
    /* Section Cards */
    .section-card {
      background-color: var(--card-background);
      border-radius: 12px;
      box-shadow: 0 4px 12px var(--shadow-color);
      margin-bottom: 24px;
      overflow: hidden;
    }
    
    .section-header {
      padding: 16px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid var(--border-color);
    }
    
    .section-title {
      font-size: 16px;
      font-weight: 600;
    }
    
    .section-action {
      font-size: 14px;
      color: var(--primary-color);
      text-decoration: none;
      font-weight: 500;
    }
    
    .section-content {
      padding: 20px;
    }
    
    /* Tables */
    .data-table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .data-table th {
      text-align: left;
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      padding: 12px 20px;
      border-bottom: 1px solid var(--border-color);
    }
    
    .data-table td {
      padding: 12px 20px;
      font-size: 14px;
      border-bottom: 1px solid var(--border-color);
    }
    
    .data-table tr:last-child td {
      border-bottom: none;
    }
    
    .data-table tr:hover td {
      background-color: var(--primary-light);
    }
    
    /* Status Labels */
    .status-badge {
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      display: inline-block;
    }
    
    .status-pending {
      background-color: var(--warning-color);
      color: white;
    }
    
    .status-completed {
      background-color: var(--success-color);
      color: white;
    }
    
    .status-cancelled {
      background-color: var(--danger-color);
      color: white;
    }
    
    /* Tabs */
    .tabs {
      display: flex;
      border-bottom: 1px solid var(--border-color);
      margin-bottom: 16px;
    }
    
    .tab {
      padding: 12px 20px;
      font-size: 14px;
      font-weight: 500;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s;
      border-bottom: 2px solid transparent;
    }
    
    .tab.active {
      color: var(--primary-color);
      border-bottom-color: var(--primary-color);
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    /* Action Buttons */
    .action-button {
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      margin-right: 6px;
      border: none;
      transition: all 0.2s;
    }
    
    .action-edit {
      background-color: #007AFF;
      color: white;
    }
    
    .action-delete {
      background-color: var(--danger-color);
      color: white;
    }
    
    .action-view {
      background-color: var(--primary-color);
      color: white;
    }
    
    /* Chart Container Styles */
    .chart-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 24px;
      margin-bottom: 24px;
    }
    
    .chart-container {
      background-color: var(--card-background);
      border-radius: 12px;
      box-shadow: 0 4px 12px var(--shadow-color);
      padding: 20px;
      position: relative;
    }
    
    .chart-container.large {
      grid-column: span 2;
    }
    
    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    
    .chart-title {
      font-size: 16px;
      font-weight: 600;
    }
    
    .chart-controls {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .time-filter {
      padding: 6px 12px;
      border-radius: 6px;
      border: 1px solid var(--border-color);
      background-color: var(--card-background);
      font-size: 12px;
      cursor: pointer;
    }
    
    .chart-legend {
      display: flex;
      gap: 12px;
      margin-top: 12px;
      flex-wrap: wrap;
      justify-content: center;
    }
    
    .legend-item {
      display: flex;
      align-items: center;
      font-size: 12px;
      cursor: pointer;
    }
    
    .legend-color {
      width: 12px;
      height: 12px;
      border-radius: 2px;
      margin-right: 6px;
    }
    
    .chart-tooltip {
      background-color: var(--card-background);
      box-shadow: 0 4px 12px var(--shadow-color);
      border-radius: 6px;
      padding: 10px;
      font-size: 12px;
    }
    
    .chart-canvas {
      width: 100%;
      height: 300px;
      max-height: 300px;
    }
    
    /* Data Grid */
    .data-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      margin-bottom: 24px;
    }
    
    .data-card {
      background-color: var(--card-background);
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 4px 12px var(--shadow-color);
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
    }
    
    .data-icon {
      font-size: 24px;
      margin-bottom: 12px;
      color: var(--primary-color);
    }
    
    .data-value {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 6px;
    }
    
    .data-label {
      font-size: 12px;
      color: var(--text-secondary);
    }
  </style>
</head>
<body>
  <!-- Sidebar Navigation -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <img src="/static/img/logo.png" alt="SnapList Logo">
      <h1>SnapList Admin</h1>
    </div>
    
    <div class="nav-section">
      <div class="nav-section-title">Overview</div>
      <a href="#" class="nav-item active">
        <span class="nav-item-icon">📊</span>
        Dashboard
      </a>
    </div>
    
    <div class="nav-section">
      <div class="nav-section-title">Management</div>
      <a href="#" class="nav-item" data-section="users">
        <span class="nav-item-icon">👤</span>
        Users
      </a>
      <a href="#" class="nav-item" data-section="listings">
        <span class="nav-item-icon">📦</span>
        Listings
      </a>
      <a href="#" class="nav-item" data-section="payouts">
        <span class="nav-item-icon">💰</span>
        Payouts
      </a>
    </div>
    
    <div class="nav-section">
      <div class="nav-section-title">Communications</div>
      <a href="#" class="nav-item" data-section="support">
        <span class="nav-item-icon">💬</span>
        Support Chats
      </a>
    </div>
    
    <div class="sidebar-footer">
      <button id="logoutButton" class="logout-button">Logout</button>
    </div>
  </aside>
  
  <!-- Main Content Area -->
  <main class="main-content">
    <header class="page-header">
      <h1 class="page-title">Dashboard</h1>
      <div class="date-display" id="currentDate"></div>
    </header>
    
    <!-- Stats Overview -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-title">Total Revenue</div>
        <div class="stat-value" id="totalRevenue">$12,485.50</div>
        <div class="stat-change positive" id="revenueChange">↑ 12.5% from last month</div>
      </div>
      
      <div class="stat-card">
        <div class="stat-title">Active Users</div>
        <div class="stat-value" id="activeUsers">872</div>
        <div class="stat-change positive" id="usersChange">↑ 5.2% from last month</div>
      </div>
      
      <div class="stat-card">
        <div class="stat-title">Active Listings</div>
        <div class="stat-value" id="activeListings">3,412</div>
        <div class="stat-change positive" id="listingsChange">↑ 8.7% from last month</div>
      </div>
      
      <div class="stat-card">
        <div class="stat-title">Completed Sales</div>
        <div class="stat-value" id="completedSales">678</div>
        <div class="stat-change positive" id="salesChange">↑ 15.3% from last month</div>
      </div>
    </div>
    
    <!-- Revenue Trend Chart (Full Width) -->
    <div class="chart-container large">
      <div class="chart-header">
        <div class="chart-title">Revenue Trends</div>
        <div class="chart-controls">
          <input type="text" id="revenueDateRange" class="time-filter" value="Last 30 Days" readonly>
        </div>
      </div>
      <canvas id="revenueChart" class="chart-canvas"></canvas>
    </div>
    
    <!-- Charts Grid (2-column layout) -->
    <div class="chart-grid">
      <!-- Sales Distribution Chart -->
      <div class="chart-container">
        <div class="chart-header">
          <div class="chart-title">Sales by Category</div>
          <div class="chart-controls">
            <select id="categoryTimeFilter" class="time-filter">
              <option value="week">This Week</option>
              <option value="month" selected>This Month</option>
              <option value="quarter">This Quarter</option>
              <option value="year">This Year</option>
            </select>
          </div>
        </div>
        <canvas id="categoryChart" class="chart-canvas"></canvas>
      </div>
      
      <!-- Regional Sales Chart -->
      <div class="chart-container">
        <div class="chart-header">
          <div class="chart-title">Regional Performance</div>
          <div class="chart-controls">
            <select id="regionTimeFilter" class="time-filter">
              <option value="week">This Week</option>
              <option value="month" selected>This Month</option>
              <option value="quarter">This Quarter</option>
              <option value="year">This Year</option>
            </select>
          </div>
        </div>
        <canvas id="regionChart" class="chart-canvas"></canvas>
      </div>
      
      <!-- User Growth Chart -->
      <div class="chart-container">
        <div class="chart-header">
          <div class="chart-title">User Growth</div>
          <div class="chart-controls">
            <select id="userGrowthPeriod" class="time-filter">
              <option value="3months">Last 3 Months</option>
              <option value="6months" selected>Last 6 Months</option>
              <option value="year">Last Year</option>
            </select>
          </div>
        </div>
        <canvas id="userGrowthChart" class="chart-canvas"></canvas>
      </div>
      
      <!-- Conversion Funnel Chart -->
      <div class="chart-container">
        <div class="chart-header">
          <div class="chart-title">Conversion Funnel</div>
          <div class="chart-controls">
            <select id="conversionPeriod" class="time-filter">
              <option value="week">This Week</option>
              <option value="month" selected>This Month</option>
              <option value="quarter">This Quarter</option>
            </select>
          </div>
        </div>
        <canvas id="conversionChart" class="chart-canvas"></canvas>
      </div>
    </div>
    
    <!-- Key Performance Indicators -->
    <div class="data-grid">
      <div class="data-card">
        <div class="data-icon">⏱️</div>
        <div class="data-value" id="avgListingTime">-</div>
        <div class="data-label">Avg. Time to Sell</div>
      </div>
      
      <div class="data-card">
        <div class="data-icon">💰</div>
        <div class="data-value" id="avgOrderValue">-</div>
        <div class="data-label">Avg. Order Value</div>
      </div>
      
      <div class="data-card">
        <div class="data-icon">🔄</div>
        <div class="data-value" id="returnRate">-</div>
        <div class="data-label">Return Rate</div>
      </div>
      
      <div class="data-card">
        <div class="data-icon">👥</div>
        <div class="data-value" id="userRetention">-</div>
        <div class="data-label">User Retention</div>
      </div>
      
      <div class="data-card">
        <div class="data-icon">⭐</div>
        <div class="data-value" id="avgRating">-</div>
        <div class="data-label">Avg. Rating</div>
      </div>
      
      <div class="data-card">
        <div class="data-icon">📱</div>
        <div class="data-value" id="mobileUsage">-</div>
        <div class="data-label">Mobile Usage</div>
      </div>
    </div>
  </main>
  
  <script>
    // Authentication Check
    function checkAuth() {
      const isAuthenticated = localStorage.getItem('snaplist_admin_auth');
      if (!isAuthenticated) {
        window.location.href = '/admin/login.html';
      }
    }
    
    // Logout Function
    document.getElementById('logoutButton').addEventListener('click', function() {
      localStorage.removeItem('snaplist_admin_auth');
      window.location.href = '/admin/login.html';
    });
    
    // Display Current Date
    function displayCurrentDate() {
      const date = new Date();
      const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
      document.getElementById('currentDate').textContent = date.toLocaleDateString('en-US', options);
    }
    
    // Fetch Stats from API
    async function fetchDashboardStats() {
      try {
        const response = await fetch('/api/admin/stats');
        if (!response.ok) {
          throw new Error('Failed to fetch stats');
        }
        
        const data = await response.json();
        if (data.success) {
          // Update stats in the UI
          document.getElementById('totalRevenue').textContent = '$' + data.stats.totalProfit.toFixed(2);
          document.getElementById('activeUsers').textContent = data.stats.userCount;
          document.getElementById('activeListings').textContent = data.stats.activeListingCount;
          document.getElementById('completedSales').textContent = data.stats.soldCount;
          
          // Update month-over-month changes from API
          if (data.stats.monthlyChanges) {
            const formatPercentage = (val) => {
              const prefix = val >= 0 ? '↑ ' : '↓ ';
              return `${prefix}${Math.abs(val).toFixed(1)}% from last month`;
            };
            
            const changes = data.stats.monthlyChanges;
            if (changes.revenue !== undefined) {
              document.getElementById('revenueChange').textContent = formatPercentage(changes.revenue);
              document.getElementById('revenueChange').className = `stat-change ${changes.revenue >= 0 ? 'positive' : 'negative'}`;
            }
            
            if (changes.users !== undefined) {
              document.getElementById('usersChange').textContent = formatPercentage(changes.users);
              document.getElementById('usersChange').className = `stat-change ${changes.users >= 0 ? 'positive' : 'negative'}`;
            }
            
            if (changes.listings !== undefined) {
              document.getElementById('listingsChange').textContent = formatPercentage(changes.listings);
              document.getElementById('listingsChange').className = `stat-change ${changes.listings >= 0 ? 'positive' : 'negative'}`;
            }
            
            if (changes.sales !== undefined) {
              document.getElementById('salesChange').textContent = formatPercentage(changes.sales);
              document.getElementById('salesChange').className = `stat-change ${changes.sales >= 0 ? 'positive' : 'negative'}`;
            }
          } else {
            // Hide change stats if not available
            document.getElementById('revenueChange').style.display = 'none';
            document.getElementById('usersChange').style.display = 'none';
            document.getElementById('listingsChange').style.display = 'none';
            document.getElementById('salesChange').style.display = 'none';
          }
        }
      } catch (error) {
        console.error('Error fetching dashboard stats:', error);
        // Show error message to the user
        alert('Failed to load dashboard statistics. Please try again later.');
      }
    }
    
    // Initialize Chart.js Charts
    function initializeCharts() {
      // Revenue Trend Chart (Line Chart)
      const revenueCtx = document.getElementById('revenueChart').getContext('2d');
      const revenueChart = new Chart(revenueCtx, {
        type: 'line',
        data: {
          labels: [], // Will be populated by API data
          datasets: [
            {
              label: 'Revenue',
              data: [], // Will be populated by API data
              borderColor: '#FF6A00',
              backgroundColor: 'rgba(255, 106, 0, 0.1)',
              borderWidth: 2,
              fill: true,
              tension: 0.4
            },
            {
              label: 'Profit',
              data: [], // Will be populated by API data
              borderColor: '#34C759',
              backgroundColor: 'rgba(52, 199, 89, 0.1)',
              borderWidth: 2,
              fill: true,
              tension: 0.4
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            tooltip: {
              mode: 'index',
              intersect: false,
              backgroundColor: 'rgba(0, 0, 0, 0.7)',
              padding: 10,
              titleColor: '#FFFFFF',
              bodyColor: '#FFFFFF',
              borderColor: 'rgba(255, 255, 255, 0.2)',
              borderWidth: 1,
              displayColors: true,
              callbacks: {
                label: function(context) {
                  let label = context.dataset.label || '';
                  if (label) {
                    label += ': ';
                  }
                  if (context.parsed.y !== null) {
                    label += new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(context.parsed.y);
                  }
                  return label;
                }
              }
            },
            legend: {
              display: true,
              position: 'top',
              align: 'end',
              labels: {
                boxWidth: 12,
                usePointStyle: true,
                pointStyle: 'circle'
              }
            }
          },
          scales: {
            x: {
              grid: {
                display: false
              }
            },
            y: {
              grid: {
                borderDash: [5, 5],
                drawBorder: false
              },
              ticks: {
                callback: function(value) {
                  return '$' + value.toLocaleString();
                }
              }
            }
          },
          interaction: {
            mode: 'nearest',
            axis: 'x',
            intersect: false
          }
        }
      });
      
      // Sales by Category Chart (Pie Chart)
      const categoryCtx = document.getElementById('categoryChart').getContext('2d');
      const categoryChart = new Chart(categoryCtx, {
        type: 'doughnut',
        data: {
          labels: ['Electronics', 'Clothing', 'Home Goods', 'Collectibles', 'Sports', 'Other'],
          datasets: [{
            data: [35, 25, 15, 10, 8, 7],
            backgroundColor: [
              '#FF6A00', // Primary Orange
              '#34C759', // Green
              '#007AFF', // Blue
              '#FF9500', // Orange
              '#5856D6', // Purple
              '#FF3B30'  // Red
            ],
            borderWidth: 0,
            hoverOffset: 10
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          cutout: '70%',
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                padding: 15,
                usePointStyle: true,
                pointStyle: 'circle'
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  let label = context.label || '';
                  let value = context.parsed || 0;
                  let total = context.dataset.data.reduce((acc, data) => acc + data, 0);
                  let percentage = ((value * 100) / total).toFixed(1) + '%';
                  return `${label}: ${percentage} ($${value.toLocaleString()})`;
                }
              }
            }
          }
        }
      });
      
      // Regional Performance Chart (Bar Chart)
      const regionCtx = document.getElementById('regionChart').getContext('2d');
      const regionChart = new Chart(regionCtx, {
        type: 'bar',
        data: {
          labels: ['West', 'Northeast', 'Midwest', 'South', 'International'],
          datasets: [{
            label: 'Sales Volume',
            data: [4200, 3800, 2900, 3500, 1800],
            backgroundColor: '#FF6A00',
            borderRadius: 6
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  let label = context.dataset.label || '';
                  if (label) {
                    label += ': ';
                  }
                  if (context.parsed.y !== null) {
                    label += '$' + context.parsed.y.toLocaleString();
                  }
                  return label;
                }
              }
            }
          },
          scales: {
            x: {
              grid: {
                display: false
              }
            },
            y: {
              beginAtZero: true,
              grid: {
                borderDash: [5, 5],
                drawBorder: false
              },
              ticks: {
                callback: function(value) {
                  return '$' + value.toLocaleString();
                }
              }
            }
          }
        }
      });
      
      // User Growth Chart (Line Chart)
      const userGrowthCtx = document.getElementById('userGrowthChart').getContext('2d');
      const userGrowthChart = new Chart(userGrowthCtx, {
        type: 'line',
        data: {
          labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
          datasets: [{
            label: 'New Users',
            data: [120, 145, 170, 210, 240, 280],
            borderColor: '#007AFF',
            backgroundColor: 'rgba(0, 122, 255, 0.1)',
            borderWidth: 2,
            fill: true,
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            }
          },
          scales: {
            x: {
              grid: {
                display: false
              }
            },
            y: {
              beginAtZero: true,
              grid: {
                borderDash: [5, 5]
              }
            }
          }
        }
      });
      
      // Conversion Funnel Chart (Bar Chart)
      const conversionCtx = document.getElementById('conversionChart').getContext('2d');
      const conversionChart = new Chart(conversionCtx, {
        type: 'bar',
        data: {
          labels: ['Visitors', 'Sign-ups', 'Listings Created', 'Sales'],
          datasets: [{
            axis: 'y',
            data: [10000, 3200, 1800, 760],
            backgroundColor: [
              'rgba(0, 122, 255, 0.8)',
              'rgba(52, 199, 89, 0.8)',
              'rgba(255, 149, 0, 0.8)',
              'rgba(255, 106, 0, 0.8)'
            ],
            borderRadius: 6
          }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  let value = context.parsed.x;
                  let total = 10000; // Total visitors
                  let percentage = ((value / total) * 100).toFixed(1) + '%';
                  return `Count: ${value.toLocaleString()} (${percentage})`;
                }
              }
            }
          },
          scales: {
            x: {
              beginAtZero: true,
              grid: {
                borderDash: [5, 5]
              },
              ticks: {
                callback: function(value) {
                  if (value >= 1000) {
                    return value / 1000 + 'k';
                  }
                  return value;
                }
              }
            },
            y: {
              grid: {
                display: false
              }
            }
          }
        }
      });
      
      return {
        revenueChart,
        categoryChart,
        regionChart,
        userGrowthChart,
        conversionChart
      };
    }
    
    // Fetch Revenue Trend Data
    async function fetchRevenueData(timeRange = '30days') {
      try {
        const response = await fetch(`/api/admin/analytics/revenue?timeRange=${timeRange}`);
        if (!response.ok) {
          throw new Error('Failed to fetch revenue data');
        }
        
        const data = await response.json();
        if (data.success) {
          return {
            labels: data.dates,
            revenue: data.revenue,
            profit: data.profit
          };
        } else {
          throw new Error(data.message || 'Failed to get revenue data');
        }
      } catch (error) {
        console.error('Error fetching revenue data:', error);
        // Return minimal fallback data instead of random generation
        const labels = [];
        const today = new Date();
        for (let i = 29; i >= 0; i--) {
          const date = new Date();
          date.setDate(today.getDate() - i);
          labels.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
        }
        return {
          labels: labels,
          revenue: new Array(30).fill(0),
          profit: new Array(30).fill(0)
        };
      }
    }
    
    // Fetch Category Sales Data
    async function fetchCategoryData(timeRange = 'month') {
      try {
        const response = await fetch(`/api/admin/analytics/categories?timeRange=${timeRange}`);
        if (!response.ok) {
          throw new Error('Failed to fetch category data');
        }
        
        const data = await response.json();
        if (data.success) {
          return {
            labels: data.categories,
            values: data.values
          };
        } else {
          throw new Error(data.message || 'Failed to get category data');
        }
      } catch (error) {
        console.error('Error fetching category data:', error);
        // Return minimal fallback data
        return {
          labels: ['No Data Available'],
          values: [1]
        };
      }
    }
    
    // Fetch Regional Data
    async function fetchRegionalData(timeRange = 'month') {
      try {
        const response = await fetch(`/api/admin/analytics/regions?timeRange=${timeRange}`);
        if (!response.ok) {
          throw new Error('Failed to fetch regional data');
        }
        
        const data = await response.json();
        if (data.success) {
          return {
            labels: data.regions,
            values: data.values
          };
        } else {
          throw new Error(data.message || 'Failed to get regional data');
        }
      } catch (error) {
        console.error('Error fetching regional data:', error);
        // Return fallback data
        return {
          labels: ['West', 'Northeast', 'Midwest', 'South', 'International'],
          values: [4200, 3800, 2900, 3500, 1800]
        };
      }
    }
    
    // Fetch User Growth Data
    async function fetchUserGrowthData(timeRange = '6months') {
      try {
        const response = await fetch(`/api/admin/analytics/user-growth?timeRange=${timeRange}`);
        if (!response.ok) {
          throw new Error('Failed to fetch user growth data');
        }
        
        const data = await response.json();
        if (data.success) {
          return {
            labels: data.months,
            values: data.users
          };
        } else {
          throw new Error(data.message || 'Failed to get user growth data');
        }
      } catch (error) {
        console.error('Error fetching user growth data:', error);
        // Return fallback data
        const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'];
        return {
          labels: months,
          values: [120, 145, 170, 210, 240, 280]
        };
      }
    }
    
    // Fetch Conversion Data
    async function fetchConversionData(timeRange = 'month') {
      try {
        const response = await fetch(`/api/admin/analytics/conversion?timeRange=${timeRange}`);
        if (!response.ok) {
          throw new Error('Failed to fetch conversion data');
        }
        
        const data = await response.json();
        if (data.success) {
          return {
            labels: data.stages,
            values: data.counts
          };
        } else {
          throw new Error(data.message || 'Failed to get conversion data');
        }
      } catch (error) {
        console.error('Error fetching conversion data:', error);
        // Return fallback data
        return {
          labels: ['Visitors', 'Sign-ups', 'Listings Created', 'Sales'],
          values: [10000, 3200, 1800, 760]
        };
      }
    }
    
    // Fetch KPI Data - Calculate real values from actual data
    async function fetchKPIData() {
      try {
        // Fetch listings data to calculate KPIs
        const listingsResponse = await fetch('/api/admin/listings?limit=1000');
        const usersResponse = await fetch('/api/admin/users?limit=1000');
        const salesResponse = await fetch('/api/admin/listings?status=sold&limit=1000');
        
        if (!listingsResponse.ok || !usersResponse.ok || !salesResponse.ok) {
          throw new Error('Failed to fetch necessary data for KPIs');
        }
        
        const listingsData = await listingsResponse.json();
        const usersData = await usersResponse.json();
        const salesData = await salesResponse.json();
        
        // Calculate average time to sell
        let totalTimeToSell = 0;
        let soldCount = 0;
        
        if (salesData.success && salesData.listings && salesData.listings.length > 0) {
          salesData.listings.forEach(item => {
            if (item.created_at && item.sold_at) {
              const createdDate = new Date(item.created_at);
              const soldDate = new Date(item.sold_at);
              const daysToSell = (soldDate - createdDate) / (1000 * 60 * 60 * 24);
              if (daysToSell >= 0) {
                totalTimeToSell += daysToSell;
                soldCount++;
              }
            }
          });
          
          if (soldCount > 0) {
            const avgTimeToSell = totalTimeToSell / soldCount;
            document.getElementById('avgListingTime').textContent = `${avgTimeToSell.toFixed(1)} days`;
          } else {
            document.getElementById('avgListingTime').textContent = 'N/A';
          }
        } else {
          document.getElementById('avgListingTime').textContent = 'N/A';
        }
        
        // Calculate average order value
        let totalSalesValue = 0;
        if (salesData.success && salesData.listings && salesData.listings.length > 0) {
          salesData.listings.forEach(item => {
            if (item.price) {
              totalSalesValue += parseFloat(item.price);
            }
          });
          
          if (soldCount > 0) {
            const avgOrderValue = totalSalesValue / soldCount;
            document.getElementById('avgOrderValue').textContent = `$${avgOrderValue.toFixed(2)}`;
          } else {
            document.getElementById('avgOrderValue').textContent = 'N/A';
          }
        } else {
          document.getElementById('avgOrderValue').textContent = 'N/A';
        }
        
        // Attempt to fetch return rate from API or calculate
        try {
          const returnsResponse = await fetch('/api/admin/returns');
          if (returnsResponse.ok) {
            const returnsData = await returnsResponse.json();
            if (returnsData.success && returnsData.returnRate !== undefined) {
              document.getElementById('returnRate').textContent = `${returnsData.returnRate.toFixed(1)}%`;
            } else if (returnsData.success && returnsData.returns && soldCount > 0) {
              const returnRate = (returnsData.returns.length / soldCount) * 100;
              document.getElementById('returnRate').textContent = `${returnRate.toFixed(1)}%`;
            } else {
              document.getElementById('returnRate').textContent = '0%';
            }
          } else {
            document.getElementById('returnRate').textContent = '0%';
          }
        } catch (error) {
          console.error('Error fetching returns data:', error);
          document.getElementById('returnRate').textContent = '0%';
        }
        
        // Calculate user retention
        try {
          const retentionResponse = await fetch('/api/admin/analytics/retention');
          if (retentionResponse.ok) {
            const retentionData = await retentionResponse.json();
            if (retentionData.success && retentionData.retention !== undefined) {
              document.getElementById('userRetention').textContent = `${retentionData.retention.toFixed(1)}%`;
            } else {
              document.getElementById('userRetention').textContent = 'N/A';
            }
          } else {
            document.getElementById('userRetention').textContent = 'N/A';
          }
        } catch (error) {
          console.error('Error fetching retention data:', error);
          document.getElementById('userRetention').textContent = 'N/A';
        }
        
        // Calculate average rating
        try {
          const ratingsResponse = await fetch('/api/admin/ratings');
          if (ratingsResponse.ok) {
            const ratingsData = await ratingsResponse.json();
            if (ratingsData.success && ratingsData.ratings && ratingsData.ratings.length > 0) {
              let totalRating = 0;
              ratingsData.ratings.forEach(rating => {
                totalRating += rating.value;
              });
              const avgRating = totalRating / ratingsData.ratings.length;
              document.getElementById('avgRating').textContent = avgRating.toFixed(1);
            } else {
              document.getElementById('avgRating').textContent = 'N/A';
            }
          } else {
            document.getElementById('avgRating').textContent = 'N/A';
          }
        } catch (error) {
          console.error('Error fetching ratings data:', error);
          document.getElementById('avgRating').textContent = 'N/A';
        }
        
        // Calculate mobile usage
        try {
          const analyticsResponse = await fetch('/api/admin/analytics/platform-usage');
          if (analyticsResponse.ok) {
            const analyticsData = await analyticsResponse.json();
            if (analyticsData.success && analyticsData.mobile !== undefined) {
              document.getElementById('mobileUsage').textContent = `${analyticsData.mobile.toFixed(1)}%`;
            } else {
              document.getElementById('mobileUsage').textContent = 'N/A';
            }
          } else {
            document.getElementById('mobileUsage').textContent = 'N/A';
          }
        } catch (error) {
          console.error('Error fetching platform usage data:', error);
          document.getElementById('mobileUsage').textContent = 'N/A';
        }
        
      } catch (error) {
        console.error('Error calculating KPI data:', error);
        // Set all to N/A if calculation fails
        document.getElementById('avgListingTime').textContent = 'N/A';
        document.getElementById('avgOrderValue').textContent = 'N/A';
        document.getElementById('returnRate').textContent = 'N/A';
        document.getElementById('userRetention').textContent = 'N/A';
        document.getElementById('avgRating').textContent = 'N/A';
        document.getElementById('mobileUsage').textContent = 'N/A';
      }
    }
    
    // Update Revenue Chart
    async function updateRevenueChart(chart, timeRange) {
      const data = await fetchRevenueData(timeRange);
      
      chart.data.labels = data.labels;
      chart.data.datasets[0].data = data.revenue;
      chart.data.datasets[1].data = data.profit;
      chart.update();
    }
    
    // Update Category Chart
    async function updateCategoryChart(chart, timeRange) {
      const data = await fetchCategoryData(timeRange);
      
      chart.data.labels = data.labels;
      chart.data.datasets[0].data = data.values;
      chart.update();
    }
    
    // Update Regional Chart
    async function updateRegionalChart(chart, timeRange) {
      const data = await fetchRegionalData(timeRange);
      
      chart.data.labels = data.labels;
      chart.data.datasets[0].data = data.values;
      chart.update();
    }
    
    // Update User Growth Chart
    async function updateUserGrowthChart(chart, timeRange) {
      const data = await fetchUserGrowthData(timeRange);
      
      chart.data.labels = data.labels;
      chart.data.datasets[0].data = data.values;
      chart.update();
    }
    
    // Update Conversion Chart
    async function updateConversionChart(chart, timeRange) {
      const data = await fetchConversionData(timeRange);
      
      chart.data.labels = data.labels;
      chart.data.datasets[0].data = data.values;
      chart.update();
    }
    
    // Initialize Dashboard
    document.addEventListener('DOMContentLoaded', function() {
      checkAuth();
      displayCurrentDate();
      
      // Initialize charts first
      const charts = initializeCharts();
      
      // Setup revenue date range picker
      $('#revenueDateRange').daterangepicker({
        ranges: {
          'Last 7 Days': [moment().subtract(6, 'days'), moment()],
          'Last 30 Days': [moment().subtract(29, 'days'), moment()],
          'This Month': [moment().startOf('month'), moment().endOf('month')],
          'Last Month': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')],
          'Last 3 Months': [moment().subtract(3, 'months'), moment()],
          'Last 6 Months': [moment().subtract(6, 'months'), moment()],
          'Year to Date': [moment().startOf('year'), moment()]
        },
        startDate: moment().subtract(29, 'days'),
        endDate: moment(),
        opens: 'left',
        alwaysShowCalendars: true
      }, function(start, end, label) {
        // Get the timeframe value from the selected label
        let timeframe = '30days';
        
        if (label === 'Last 7 Days') timeframe = '7days';
        else if (label === 'Last 30 Days') timeframe = '30days';
        else if (label === 'This Month') timeframe = 'thisMonth';
        else if (label === 'Last Month') timeframe = 'lastMonth';
        else if (label === 'Last 3 Months') timeframe = '3months';
        else if (label === 'Last 6 Months') timeframe = '6months';
        else if (label === 'Year to Date') timeframe = 'ytd';
        else {
          // Custom range - format as ISO dates for API
          timeframe = `custom:${start.format('YYYY-MM-DD')}:${end.format('YYYY-MM-DD')}`;
        }
        
        updateRevenueChart(charts.revenueChart, timeframe);
      });
      
      // Setup other filters event handlers
      document.getElementById('categoryTimeFilter').addEventListener('change', function() {
        updateCategoryChart(charts.categoryChart, this.value);
      });
      
      document.getElementById('regionTimeFilter').addEventListener('change', function() {
        updateRegionalChart(charts.regionChart, this.value);
      });
      
      document.getElementById('userGrowthPeriod').addEventListener('change', function() {
        updateUserGrowthChart(charts.userGrowthChart, this.value);
      });
      
      document.getElementById('conversionPeriod').addEventListener('change', function() {
        updateConversionChart(charts.conversionChart, this.value);
      });
      
      // Fetch data for initial load
      fetchDashboardStats();
      fetchKPIData();
      
      // Load initial chart data
      updateRevenueChart(charts.revenueChart, '30days');
      updateCategoryChart(charts.categoryChart, 'month');
      updateRegionalChart(charts.regionChart, 'month');
      updateUserGrowthChart(charts.userGrowthChart, '6months');
      updateConversionChart(charts.conversionChart, 'month');
      
      // Add navigation handlers
      document.querySelectorAll('.nav-item').forEach(item => {
        item.addEventListener('click', function(e) {
          if (this.getAttribute('data-section')) {
            e.preventDefault();
            const section = this.getAttribute('data-section');
            window.location.href = `/admin/${section}.html`;
          }
        });
      });
    });
  </script>
</body>
</html> 