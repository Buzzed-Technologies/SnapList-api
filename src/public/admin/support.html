<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Support Chats - SnapList Admin</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="icon" type="image/png" href="/static/img/logo.png">
  <style>
    :root {
      --primary-color: #6366f1;
      --primary-hover: #4f46e5;
      --background-color: #f9fafb;
      --card-background: #ffffff;
      --secondary-background: #f3f4f6;
      --text-primary: #111827;
      --text-secondary: #4b5563;
      --text-tertiary: #9ca3af;
      --border-color: #e5e7eb;
      --shadow-color: rgba(0, 0, 0, 0.05);
      --success-color: #10b981;
      --warning-color: #f59e0b;
      --danger-color: #ef4444;
      --status-pending-background: #fff8e6;
      --status-pending-text: #b45309;
      --status-responded-background: #e6f7ff;
      --status-responded-text: #0369a1;
      --status-resolved-background: #ecfdf5;
      --status-resolved-text: #059669;
      --status-escalated-background: #ffecb3;
      --status-escalated-text: #e65100;
      --sidebar-width: 260px;
    }
    
    @media (prefers-color-scheme: dark) {
      :root {
        --primary-color: #FF6A00;
        --primary-light: #2C1A0D;
        --primary-dark: #FF8A3F;
        --text-primary: #FFFFFF;
        --text-secondary: #AAAAAA;
        --background-color: #1A1A1A;
        --card-background: #222222;
        --border-color: #333333;
        --shadow-color: rgba(0, 0, 0, 0.2);
      }
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Inter', sans-serif;
    }
    
    body {
      background-color: var(--background-color);
      color: var(--text-primary);
      display: flex;
      min-height: 100vh;
    }
    
    /* Sidebar Styles */
    .sidebar {
      width: var(--sidebar-width);
      background-color: var(--card-background);
      border-right: 1px solid var(--border-color);
      padding: 24px 0;
      height: 100vh;
      position: fixed;
      top: 0;
      left: 0;
      overflow-y: auto;
    }
    
    .sidebar-header {
      padding: 0 20px 20px;
      margin-bottom: 20px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      align-items: center;
    }
    
    .sidebar-header img {
      width: 32px;
      height: 32px;
      margin-right: 12px;
    }
    
    .sidebar-header h1 {
      font-size: 18px;
      font-weight: 700;
      color: var(--primary-color);
    }
    
    .nav-section {
      margin-bottom: 16px;
    }
    
    .nav-section-title {
      text-transform: uppercase;
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      padding: 8px 20px;
      margin-bottom: 4px;
    }
    
    .nav-item {
      display: flex;
      align-items: center;
      padding: 10px 20px;
      color: var(--text-primary);
      text-decoration: none;
      font-size: 14px;
      font-weight: 500;
      border-left: 3px solid transparent;
      transition: all 0.2s;
    }
    
    .nav-item.active {
      background-color: var(--primary-light);
      color: var(--primary-color);
      border-left-color: var(--primary-color);
    }
    
    .nav-item:hover:not(.active) {
      background-color: rgba(0, 0, 0, 0.03);
    }
    
    .nav-item-icon {
      width: 18px;
      height: 18px;
      margin-right: 12px;
      opacity: 0.8;
    }
    
    .sidebar-footer {
      padding: 16px 20px;
      border-top: 1px solid var(--border-color);
      margin-top: auto;
    }
    
    .logout-button {
      padding: 8px 12px;
      background-color: var(--background-color);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    
    .logout-button:hover {
      background-color: var(--danger-color);
      color: white;
      border-color: var(--danger-color);
    }
    
    /* Main Content Styles */
    .main-content {
      flex: 1;
      margin-left: var(--sidebar-width);
      padding: 24px;
    }
    
    .page-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 24px;
    }
    
    .page-title {
      font-size: 24px;
      font-weight: 700;
    }
    
    /* Support Chat Styles */
    .chat-layout {
      display: grid;
      grid-template-columns: 320px 1fr;
      gap: 24px;
      height: calc(100vh - 120px);
    }
    
    .chat-list {
      background-color: var(--card-background);
      border-radius: 12px;
      box-shadow: 0 4px 12px var(--shadow-color);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      max-height: 100%;
    }
    
    .chat-list-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .chat-list-title {
      font-size: 16px;
      font-weight: 600;
    }
    
    .chat-search {
      display: flex;
      align-items: center;
      padding: 12px 16px;
      border-bottom: 1px solid var(--border-color);
    }
    
    .chat-search input {
      flex: 1;
      border: none;
      padding: 8px;
      background-color: var(--background-color);
      border-radius: 6px;
      font-size: 14px;
      color: var(--text-primary);
    }
    
    .chat-search input:focus {
      outline: none;
      box-shadow: 0 0 0 2px var(--primary-color);
    }
    
    .chat-filter {
      display: flex;
      padding: 8px 16px;
      border-bottom: 1px solid var(--border-color);
      gap: 8px;
    }
    
    .chat-filter-button {
      flex: 1;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      background-color: var(--background-color);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
      transition: all 0.2s;
    }
    
    .chat-filter-button.active {
      background-color: var(--primary-color);
      color: white;
      border-color: var(--primary-color);
    }
    
    .chat-items {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
    }
    
    .chat-item {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border-color);
      cursor: pointer;
      transition: background-color 0.2s;
    }
    
    .chat-item:hover {
      background-color: var(--secondary-background);
    }
    
    .chat-item.active {
      background-color: var(--primary-color);
      color: white;
    }
    
    .chat-item.active .chat-item-time,
    .chat-item.active .chat-item-preview {
      color: rgba(255, 255, 255, 0.8);
    }
    
    .chat-item.escalated {
      border-left: 3px solid var(--status-escalated-text);
      background-color: var(--status-escalated-background);
    }
    
    .chat-item.escalated:hover {
      background-color: var(--status-escalated-background);
      opacity: 0.9;
    }
    
    .chat-item.escalated.active {
      background-color: var(--primary-color);
      color: white;
      border-left: 3px solid var(--warning-color);
    }
    
    .chat-item-user {
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 4px;
      display: flex;
      justify-content: space-between;
    }
    
    .chat-item-time {
      font-size: 12px;
      color: var(--text-secondary);
    }
    
    .chat-item-preview {
      font-size: 12px;
      color: var(--text-secondary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .chat-status {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      position: absolute;
      top: 12px;
      right: 12px;
    }
    
    .chat-status-pending {
      background-color: var(--warning-color);
    }
    
    .chat-status-responded {
      background-color: var(--primary-color);
    }
    
    .chat-status-resolved {
      background-color: var(--success-color);
    }
    
    /* Chat Detail View */
    .chat-detail {
      background-color: var(--card-background);
      border-radius: 12px;
      box-shadow: 0 4px 12px var(--shadow-color);
      display: flex;
      flex-direction: column;
      height: 100%;
      overflow: hidden;
    }
    
    .chat-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      justify-content: space-between;
      background-color: var(--card-background);
    }
    
    .chat-header .user-info {
      display: flex;
      flex-direction: column;
    }
    
    .chat-header .user-info h3 {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 4px;
    }
    
    .chat-header .chat-date {
      font-size: 12px;
      color: var(--text-secondary);
      margin-right: 12px;
    }
    
    .chat-header .status-selector {
      display: flex;
      align-items: center;
    }
    
    .chat-header .status-selector label {
      margin-right: 8px;
      font-size: 14px;
    }
    
    .chat-header .status-selector select {
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 14px;
      border: 1px solid var(--border-color);
      background-color: var(--card-background);
      color: var(--text-primary);
    }
    
    .chat-user-info {
      display: flex;
      align-items: center;
    }
    
    .chat-user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: var(--primary-light);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      color: var(--primary-color);
      margin-right: 12px;
    }
    
    .chat-user-name {
      font-size: 16px;
      font-weight: 600;
    }
    
    .chat-user-detail {
      font-size: 12px;
      color: var(--text-secondary);
    }
    
    .chat-action-dropdown {
      position: relative;
    }
    
    .chat-action-button {
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      background-color: var(--background-color);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .chat-detail-status {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 500;
      margin-left: 12px;
    }
    
    .chat-detail-status.pending {
      background-color: var(--warning-color);
      color: white;
    }
    
    .chat-detail-status.responded {
      background-color: var(--primary-color);
      color: white;
    }
    
    .chat-detail-status.resolved {
      background-color: var(--success-color);
      color: white;
    }
    
    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    
    .chat-message {
      max-width: 80%;
      padding: 12px 16px;
      border-radius: 12px;
      font-size: 14px;
      position: relative;
    }
    
    .chat-message-time {
      font-size: 11px;
      color: var(--text-secondary);
      margin-top: 4px;
      display: block;
    }
    
    .chat-message-user {
      background-color: var(--primary-light);
      color: var(--text-primary);
      align-self: flex-start;
      border-bottom-left-radius: 4px;
    }
    
    .chat-message-ai {
      background-color: var(--background-color);
      color: var(--text-primary);
      align-self: flex-end;
      border-bottom-right-radius: 4px;
    }
    
    .chat-message-admin {
      background-color: #E3F2FD;
      color: #0D47A1;
      align-self: flex-end;
      border-bottom-right-radius: 4px;
    }
    
    .chat-input-container {
      padding: 16px;
      border-top: 1px solid var(--border-color);
      display: flex;
      gap: 12px;
    }
    
    .chat-input {
      flex: 1;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 12px;
      font-size: 14px;
      resize: none;
      min-height: 80px;
      color: var(--text-primary);
      background-color: var(--background-color);
    }
    
    .chat-input:focus {
      outline: none;
      border-color: var(--primary-color);
    }
    
    .chat-send-button {
      padding: 12px 20px;
      background-color: var(--primary-color);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      align-self: flex-end;
    }
    
    .chat-send-button:hover {
      background-color: var(--primary-dark);
    }
    
    .chat-status-buttons {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }
    
    .status-button {
      flex: 1;
      padding: 8px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      border: none;
      transition: all 0.2s;
    }
    
    .mark-responded {
      background-color: var(--primary-color);
      color: white;
    }
    
    .mark-resolved {
      background-color: var(--success-color);
      color: white;
    }
    
    /* Empty State */
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      padding: 20px;
      text-align: center;
    }
    
    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 16px;
      color: var(--text-secondary);
    }
    
    .empty-state-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 8px;
    }
    
    .empty-state-text {
      font-size: 14px;
      color: var(--text-secondary);
      max-width: 300px;
      margin: 0 auto;
    }
    
    /* Loading */
    .loading-indicator {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 200px;
    }
    
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid var(--border-color);
      border-top: 4px solid var(--primary-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Page-specific styles */
    .message-count {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background-color: var(--background-color);
      color: var(--text-primary);
      font-size: 12px;
      font-weight: 600;
      padding: 2px 6px;
      border-radius: 10px;
      margin-left: 8px;
    }
    
    .chat-item-status {
      font-size: 12px;
      font-weight: 500;
      padding: 2px 6px;
      border-radius: 4px;
      background-color: var(--background-color);
    }
    
    .chat-item-status.pending {
      background-color: var(--status-pending-background);
      color: var(--status-pending-text);
    }
    
    .chat-item-status.responded {
      background-color: var(--status-responded-background);
      color: var(--status-responded-text);
    }
    
    .chat-item-status.resolved {
      background-color: var(--status-resolved-background);
      color: var(--status-resolved-text);
    }
    
    .chat-item-status.escalated {
      background-color: #ffecb3;
      color: #e65100;
      font-weight: 600;
    }
    
    .toggle-ai-button {
      font-size: 12px;
      background-color: var(--background-color);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      padding: 2px 6px;
      margin-left: 8px;
      cursor: pointer;
    }
    
    .hidden-ai {
      opacity: 0.5;
    }
    
    /* Notification badge */
    .notification-badge {
      position: absolute;
      top: 8px;
      right: 8px;
      background-color: var(--danger-color);
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: bold;
    }
    
    /* Notification popup */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background-color: var(--primary-color);
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      opacity: 0;
      transform: translateY(-20px);
      transition: all 0.3s ease;
      z-index: 9999;
    }
    
    .notification.show {
      opacity: 1;
      transform: translateY(0);
    }
    
    /* Refresh spinner */
    .refresh-spinner {
      width: 16px;
      height: 16px;
      border: 2px solid rgba(0, 0, 0, 0.1);
      border-top: 2px solid var(--primary-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    /* Add styles for unread indicators on escalated chats */
    .chat-item.escalated.unread {
      position: relative;
    }
    
    .chat-item.escalated.unread::after {
      content: '';
      position: absolute;
      top: 10px;
      right: 10px;
      width: 10px;
      height: 10px;
      background-color: var(--danger-color);
      border-radius: 50%;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0% {
        transform: scale(0.95);
        box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
      }
      
      70% {
        transform: scale(1);
        box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
      }
      
      100% {
        transform: scale(0.95);
        box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
      }
    }
    
    /* Additional message styles */
    .chat-message .chat-message-time {
      font-size: 11px;
      color: var(--text-secondary);
      margin-top: 4px;
      display: block;
    }
    
    /* Reply section */
    .chat-reply {
      padding: 16px;
      border-top: 1px solid var(--border-color);
    }
    
    .chat-reply .reply-header {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 8px;
    }
    
    #chatReplyInput {
      width: 100%;
      padding: 12px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      min-height: 80px;
      margin-bottom: 12px;
      background-color: var(--background-color);
      color: var(--text-primary);
      resize: vertical;
    }
    
    #chatReplySend {
      padding: 10px 16px;
      background-color: var(--primary-color);
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
    }
    
    #chatReplySend:hover {
      background-color: var(--primary-hover);
    }
    
    /* Error message styling */
    .error-message {
      padding: 20px;
      text-align: center;
      color: var(--danger-color);
    }
    
    .error-message p {
      margin-bottom: 12px;
    }
    
    .error-message button {
      padding: 8px 16px;
      background-color: var(--background-color);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <!-- Sidebar Navigation -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <img src="/static/img/logo.png" alt="SnapList Logo">
      <h1>SnapList Admin</h1>
    </div>
    
    <div class="nav-section">
      <div class="nav-section-title">Overview</div>
      <a href="/admin/dashboard.html" class="nav-item">
        <span class="nav-item-icon">📊</span>
        Dashboard
      </a>
    </div>
    
    <div class="nav-section">
      <div class="nav-section-title">Management</div>
      <a href="/admin/users.html" class="nav-item" data-section="users">
        <span class="nav-item-icon">👤</span>
        Users
      </a>
      <a href="/admin/listings.html" class="nav-item" data-section="listings">
        <span class="nav-item-icon">📦</span>
        Listings
      </a>
      <a href="/admin/payouts.html" class="nav-item" data-section="payouts">
        <span class="nav-item-icon">💰</span>
        Payouts
      </a>
    </div>
    
    <div class="nav-section">
      <div class="nav-section-title">Communications</div>
      <a href="#" class="nav-item active" data-section="support">
        <span class="nav-item-icon">💬</span>
        Support Chats
      </a>
    </div>
    
    <div class="sidebar-footer">
      <button id="logoutButton" class="logout-button">Logout</button>
    </div>
  </aside>
  
  <!-- Main Content Area -->
  <main class="main-content">
    <header class="page-header">
      <h1 class="page-title">Support Chats</h1>
      <div class="date-display" id="currentDate"></div>
    </header>
    
    <!-- Chat Interface -->
    <div class="chat-layout">
      <!-- Chat List -->
      <div class="chat-list">
        <div class="chat-list-header">
          <div class="chat-list-title">Conversations</div>
          <div class="chat-list-count" id="chatCount">Loading...</div>
        </div>
        
        <div class="chat-search">
          <input type="text" id="chatSearchInput" placeholder="Search conversations...">
        </div>
        
        <div class="chat-filter">
          <button class="chat-filter-button active" data-filter="all">All</button>
          <button class="chat-filter-button" data-filter="pending">Pending</button>
          <button class="chat-filter-button" data-filter="escalated">Escalated</button>
          <button class="chat-filter-button" data-filter="responded">Responded</button>
          <button class="chat-filter-button" data-filter="resolved">Resolved</button>
        </div>
        
        <div class="chat-items" id="chatList">
          <!-- Chat items will be dynamically populated -->
          <div class="loading-indicator">
            <div class="loading-spinner"></div>
          </div>
        </div>
      </div>
      
      <!-- Chat Detail -->
      <div class="chat-detail" id="chatDetail">
        <!-- Empty state initially -->
        <div class="empty-state">
          <div class="empty-state-icon">💬</div>
          <h3 class="empty-state-title">No conversation selected</h3>
          <p class="empty-state-text">Click on a conversation from the list to view and respond to support inquiries.</p>
        </div>
      </div>
    </div>
  </main>
  
  <script>
    /* Global variables */
    // Global variables
    let currentSearch = '';
    let currentFilter = 'all';
    let currentChatId = null;
    let currentConversationId = null;
    let chatData = [];
    let mainListRefreshInterval = null;
    let chatRefreshInterval = null;
    let newEscalatedCount = 0;
    // Create audio object for notification sound
    let notificationSound = null;
    
    // Date formatting options
    const dateOptions = { 
      year: 'numeric', 
      month: 'short', 
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    };
    
    // Format a timestamp into a relative time string like "2 hours ago"
    function formatRelativeTime(timestamp) {
      const now = new Date();
      const date = new Date(timestamp);
      const diffInSeconds = Math.floor((now - date) / 1000);
      
      if (diffInSeconds < 60) {
        return 'just now';
      }
      
      const diffInMinutes = Math.floor(diffInSeconds / 60);
      if (diffInMinutes < 60) {
        return `${diffInMinutes} ${diffInMinutes === 1 ? 'minute' : 'minutes'} ago`;
      }
      
      const diffInHours = Math.floor(diffInMinutes / 60);
      if (diffInHours < 24) {
        return `${diffInHours} ${diffInHours === 1 ? 'hour' : 'hours'} ago`;
      }
      
      const diffInDays = Math.floor(diffInHours / 24);
      if (diffInDays < 7) {
        return `${diffInDays} ${diffInDays === 1 ? 'day' : 'days'} ago`;
      }
      
      const diffInWeeks = Math.floor(diffInDays / 7);
      if (diffInWeeks < 4) {
        return `${diffInWeeks} ${diffInWeeks === 1 ? 'week' : 'weeks'} ago`;
      }
      
      const diffInMonths = Math.floor(diffInDays / 30);
      if (diffInMonths < 12) {
        return `${diffInMonths} ${diffInMonths === 1 ? 'month' : 'months'} ago`;
      }
      
      const diffInYears = Math.floor(diffInDays / 365);
      return `${diffInYears} ${diffInYears === 1 ? 'year' : 'years'} ago`;
    }
    
    // Helper function to truncate text
    function truncateText(text, maxLength) {
      if (!text) return '';
      return text.length > maxLength ? text.slice(0, maxLength) + '...' : text;
    }
    
    // Format a timestamp into a detailed time string
    function formatDetailedTime(timestamp) {
      if (!timestamp) return 'N/A';
      const date = new Date(timestamp);
      return date.toLocaleDateString('en-US', { 
        year: 'numeric', 
        month: 'short', 
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }
    
    // Get user initials from name
    function getUserInitials(name) {
      if (!name) return '?';
      const parts = name.split(' ');
      if (parts.length === 1) return parts[0].charAt(0).toUpperCase();
      return (parts[0].charAt(0) + parts[parts.length - 1].charAt(0)).toUpperCase();
    }
    
    // Display current date
    function displayCurrentDate() {
      const currentDate = new Date();
      const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
      document.getElementById('currentDate').textContent = currentDate.toLocaleDateString(undefined, options);
    }
    
    // Check authentication
    async function checkAuth() {
      try {
        const response = await fetch('/api/admin/auth/check');
        const data = await response.json();
          if (!data.authenticated) {
            window.location.href = '/admin/login.html';
          }
      } catch (error) {
          console.error('Error checking authentication:', error);
          window.location.href = '/admin/login.html';
      }
    }
    
    // Log out
    function logout() {
      fetch('/api/admin/auth/logout', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            window.location.href = '/admin/login.html';
          } else {
            alert('Logout failed: ' + data.message);
          }
        })
        .catch(error => {
          console.error('Logout error:', error);
          alert('Logout failed: ' + error.message);
        });
    }
    
    // Fetch Support Chats
    async function fetchSupportChats(searchQuery = null, statusFilter = null) {
      try {
        const chatList = document.getElementById('chatList');
        chatList.innerHTML = '<div class="loading-indicator">Loading chats...</div>';
        
        // Show loading first
        document.getElementById('chatCount').textContent = '...';
        
        // Add search and filter
        const params = new URLSearchParams();
        
        // Use the provided parameters or fall back to the current values
        const search = searchQuery !== null ? searchQuery : currentSearch;
        const filter = statusFilter !== null ? statusFilter : currentFilter;
        
        // Update current filter buttons UI
        if (statusFilter !== null) {
          document.querySelectorAll('.chat-filter-button').forEach(btn => {
            btn.classList.remove('active');
            if (btn.dataset.filter === statusFilter) {
              btn.classList.add('active');
            }
          });
        }
        
        if (search) {
          params.append('search', search);
        }
        
        if (filter !== 'all') {
          params.append('status', filter);
        }
        
        let url = '/api/admin/support-chats';
        
        if (params.toString()) {
          url += `?${params.toString()}`;
        }
        
        const response = await fetch(url);
        if (!response.ok) {
          throw new Error('Failed to fetch support chats');
        }
        
        const data = await response.json();
        if (data.success) {
          // Update chat count
          document.getElementById('chatCount').textContent = `${data.chats.length} chats`;
          
          // Store chat data globally
          chatData = data.chats;
          
          // Render chats
          renderChatList(data.chats);
          
          // If we had a selected chat, keep it selected
          if (currentChatId) {
            const selectedChat = data.chats.find(chat => chat.id === currentChatId);
            if (selectedChat) {
              loadChatDetail(selectedChat);
            }
          }
          
          return Promise.resolve(data.chats);
        } else {
          throw new Error(data.message || 'Failed to fetch support chats');
        }
      } catch (error) {
        console.error('Error fetching support chats:', error);
        document.getElementById('chatList').innerHTML = `
          <div style="padding: 20px; text-align: center;">
            <p>Error loading chats: ${error.message}</p>
            <button onclick="fetchSupportChats()" style="margin-top: 10px; padding: 8px 16px;">Try Again</button>
          </div>
        `;
        return Promise.reject(error);
      }
    }
    
    // Render Chat List
    function renderChatList(chats) {
      const chatList = document.getElementById('chatList');
      
      if (chats.length === 0) {
        chatList.innerHTML = `
          <div style="padding: 20px; text-align: center;">
            <p>No chats found</p>
          </div>
        `;
        return;
      }
      
      chatList.innerHTML = '';
      
      // Group chats by conversation_id to avoid duplicates
      const conversationMap = new Map();
      
      chats.forEach(chat => {
        const convId = chat.conversation_id || chat.id; // Use conversation_id if available, otherwise use id
        
        // Only add if this conversation isn't in the map yet, or if this chat is newer
        if (!conversationMap.has(convId) || 
            new Date(chat.created_at) > new Date(conversationMap.get(convId).created_at)) {
          conversationMap.set(convId, chat);
        }
      });
      
      // Render the unique conversations
      Array.from(conversationMap.values())
        .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
        .forEach(chat => {
        const chatItem = document.createElement('div');
          chatItem.className = `chat-item ${chat.status}`;
        chatItem.dataset.id = chat.id;
          chatItem.dataset.conversationId = chat.conversation_id || chat.id;
          
          // Get short preview of the message (max 50 chars)
          const messagePreview = chat.message.length > 50 
            ? chat.message.substring(0, 47) + '...' 
            : chat.message;
          
          // Format the date for display
          const date = new Date(chat.created_at);
          const formattedDate = date.toLocaleString('en-US', dateOptions);

          // Convert status to a more readable format
          let statusText = chat.status.charAt(0).toUpperCase() + chat.status.slice(1);
          let statusClass = chat.status;
          
          // Highlight escalated chats
          if (chat.status === 'escalated') {
            statusClass = 'escalated';
            statusText = '⚠️ Escalated';
          }
          
          // Show conversation message count if available
          const messageCountDisplay = chat.message_count && chat.message_count > 1
            ? `<span class="message-count" title="${chat.message_count} messages in this conversation">${chat.message_count}</span>`
            : '';
        
        chatItem.innerHTML = `
            <div class="chat-item-content">
              <div class="chat-item-header">
                <div class="chat-item-user">${chat.users?.name || 'Unknown User'}</div>
                <div class="chat-item-time">${formattedDate}</div>
          </div>
              <div class="chat-item-preview">${messagePreview}</div>
              <div class="chat-item-footer">
                <div class="chat-item-status ${statusClass}">${statusText}</div>
                ${messageCountDisplay}
              </div>
            </div>
        `;
        
        chatItem.addEventListener('click', () => {
            // Deselect all other items
          document.querySelectorAll('.chat-item').forEach(item => {
            item.classList.remove('active');
          });
          
            // Select this item
          chatItem.classList.add('active');
          
            // Set as current chat
          currentChatId = chat.id;
          
            // Load chat detail - if we have a conversation_id, load the full conversation
            if (chat.conversation_id) {
              loadConversationDetail(chat);
            } else {
          loadChatDetail(chat);
            }
            
            // Update URL with the chat ID for sharing/bookmarking
            window.history.replaceState({}, '', `?id=${chat.id}`);
        });
        
        chatList.appendChild(chatItem);
      });
    }
    
    // Load Chat Detail
    function loadChatDetail(chat) {
      if (!chat) {
        console.error('Attempted to load chat detail with undefined chat object');
        return;
      }
      
      const chatDetail = document.getElementById('chatDetail');
      
      // Set current conversation ID for auto-refresh
      currentConversationId = chat.conversation_id || chat.id;
      
      // Format dates for display
      const created = new Date(chat.created_at);
      const formattedCreated = created.toLocaleString('en-US', dateOptions);
      
      let formattedUpdated = 'Not updated';
      if (chat.updated_at) {
        const updated = new Date(chat.updated_at);
        formattedUpdated = updated.toLocaleString('en-US', dateOptions);
      }
      
      // Format status display
      const statusClass = chat.status || 'pending';
      const statusDisplay = chat.status ? (chat.status.charAt(0).toUpperCase() + chat.status.slice(1)) : 'Pending';
      
      // Generate the HTML for the chat detail
      chatDetail.innerHTML = `
        <div class="chat-header">
          <div class="user-info">
            <h3>${chat.users?.name || 'Unknown User'}</h3>
            <div class="chat-dates">
              <span class="chat-date">Created: ${formattedCreated}</span>
              <span class="chat-date">Last Updated: ${formattedUpdated}</span>
            </div>
          </div>
          <div class="chat-actions">
            <div class="status-selector">
              <label for="statusSelect">Status:</label>
              <select id="statusSelect">
                <option value="pending" ${chat.status === 'pending' ? 'selected' : ''}>Pending</option>
                <option value="escalated" ${chat.status === 'escalated' ? 'selected' : ''}>Escalated</option>
                <option value="responded" ${chat.status === 'responded' ? 'selected' : ''}>Responded</option>
                <option value="resolved" ${chat.status === 'resolved' ? 'selected' : ''}>Resolved</option>
              </select>
            </div>
          </div>
        </div>
        <div class="chat-messages" id="chatMessages">
          <div class="chat-message chat-message-user">
            ${escapeHtml(chat.message)}
            <span class="chat-message-time">${formattedCreated}</span>
          </div>
          <div class="chat-message ${chat.hide_ai_response ? 'hidden-ai' : ''}">
            ${escapeHtml(chat.ai_response)}
            <span class="chat-message-time">${formattedCreated}</span>
            <button class="toggle-ai-button" id="toggleAiButton">${chat.hide_ai_response ? 'Show AI Response' : 'Hide AI Response'}</button>
          </div>
          ${chat.admin_response ? `
            <div class="chat-message chat-message-admin">
              ${escapeHtml(chat.admin_response)}
              <span class="chat-message-time">${formattedUpdated}</span>
            </div>
          ` : ''}
        </div>
        <div class="chat-reply" id="chatReply">
          <div class="reply-header">Response</div>
          <textarea id="chatReplyInput" placeholder="Type your response..."></textarea>
          <button id="chatReplySend">Send Response</button>
        </div>
      `;
      
      // Add event listeners to the status selector
      document.getElementById('statusSelect').addEventListener('change', function(e) {
        updateChatStatus(chat.id, e.target.value);
      });
      
      // Add event listener to the toggle AI button
      document.getElementById('toggleAiButton').addEventListener('click', function() {
        toggleAiResponse(chat.id);
      });
      
      // Add event listener to the send button
      document.getElementById('chatReplySend').addEventListener('click', function() {
        sendAdminReply(chat.id);
      });
      
      // Add event listener for Enter key in the textarea
      document.getElementById('chatReplyInput').addEventListener('keydown', function(e) {
        // Check if Enter is pressed without Shift
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault(); // Prevent the default action (newline)
          sendAdminReply(chat.id);
        }
      });
    }
    
    // Load the entire conversation for a chat
    function loadConversationDetail(chat) {
      if (!chat) {
        console.error('Attempted to load conversation detail with undefined chat object');
        return;
      }
      
      // Set current conversation ID for auto-refresh
      currentConversationId = chat.conversation_id || chat.id;
      
      // Start chat refresh
      startChatRefresh();
      
      // Start by showing a loading indicator
      const chatDetail = document.getElementById('chatDetail');
      chatDetail.innerHTML = `
        <div class="loading-indicator">
          <div class="loading-spinner"></div>
          <div>Loading conversation...</div>
        </div>
      `;
      
      // Get the conversation_id
      const conversationId = chat.conversation_id || chat.id;
      
      // Fetch all messages in this conversation
      fetch(`/api/admin/support-chats/conversation/${conversationId}`)
        .then(response => {
          if (!response.ok) {
            if (response.status === 404) {
              throw new Error('Conversation not found');
            } else {
              return response.json().then(errData => {
                throw new Error(errData.message || 'Failed to fetch conversation');
              });
            }
          }
          return response.json();
        })
        .then(data => {
          if (!data.success) {
            throw new Error(data.message || 'Failed to fetch conversation');
          }
          
          const messages = data.messages || [];
          
          // Format dates for display
          const created = new Date(chat.created_at);
          const formattedCreated = created.toLocaleString('en-US', dateOptions);
          
          let formattedUpdated = 'Not updated';
          if (chat.updated_at) {
            const updated = new Date(chat.updated_at);
            formattedUpdated = updated.toLocaleString('en-US', dateOptions);
          }
          
          // Generate the HTML for the conversation header
          let conversationHTML = `
            <div class="chat-header">
              <div class="user-info">
                <h3>${chat.users?.name || 'Unknown User'}</h3>
                <div class="chat-dates">
                  <span class="chat-date">Created: ${formattedCreated}</span>
                  <span class="chat-date">Last Updated: ${formattedUpdated}</span>
                </div>
              </div>
              <div class="chat-actions">
                <div class="status-selector">
                  <label for="statusSelect">Status:</label>
                  <select id="statusSelect">
                    <option value="pending" ${chat.status === 'pending' ? 'selected' : ''}>Pending</option>
                    <option value="escalated" ${chat.status === 'escalated' ? 'selected' : ''}>Escalated</option>
                    <option value="responded" ${chat.status === 'responded' ? 'selected' : ''}>Responded</option>
                    <option value="resolved" ${chat.status === 'resolved' ? 'selected' : ''}>Resolved</option>
                  </select>
                </div>
              </div>
            </div>
            <div class="chat-messages" id="chatMessages">
          `;
          
          // Add each message to the conversation
          messages.forEach(msg => {
            const msgCreated = new Date(msg.created_at);
            const msgFormattedCreated = msgCreated.toLocaleString('en-US', dateOptions);
            
            // Add user message
            conversationHTML += `
              <div class="chat-message chat-message-user">
                ${escapeHtml(msg.message)}
                <span class="chat-message-time">${msgFormattedCreated}</span>
              </div>
            `;
            
            // Add AI response if it exists and isn't hidden
            conversationHTML += `
              <div class="chat-message ${msg.hide_ai_response ? 'hidden-ai' : ''}">
                ${escapeHtml(msg.ai_response)}
                <span class="chat-message-time">${msgFormattedCreated}</span>
                <button class="toggle-ai-button" data-id="${msg.id}">${msg.hide_ai_response ? 'Show AI Response' : 'Hide AI Response'}</button>
              </div>
            `;
            
            // Add admin response if it exists
            if (msg.admin_response) {
              let msgUpdated = new Date(msg.updated_at || msg.created_at);
              let msgFormattedUpdated = msgUpdated.toLocaleString('en-US', dateOptions);
              
              conversationHTML += `
                <div class="chat-message chat-message-admin">
                  ${escapeHtml(msg.admin_response)}
                  <span class="chat-message-time">${msgFormattedUpdated}</span>
                </div>
              `;
            }
          });
          
          // Close the messages div and add the reply section
          conversationHTML += `
            </div>
            <div class="chat-reply" id="chatReply">
              <div class="reply-header">Response</div>
              <textarea id="chatReplyInput" placeholder="Type your response..."></textarea>
              <button id="chatReplySend">Send Response</button>
            </div>
          `;
          
          // Set the HTML
          chatDetail.innerHTML = conversationHTML;
          
          // Add event listener to the status selector
          document.getElementById('statusSelect').addEventListener('change', function(e) {
            updateChatStatus(chat.id, e.target.value);
          });
          
          // Add event listeners to all toggle AI buttons
          document.querySelectorAll('.toggle-ai-button').forEach(button => {
            button.addEventListener('click', function() {
              toggleAiResponse(button.dataset.id);
            });
          });
          
          // Add event listener to the send button to respond to the most recent message
          document.getElementById('chatReplySend').addEventListener('click', function() {
            // Get the ID of the latest message in the conversation
            const latestMessageId = messages.length > 0 
              ? messages[messages.length - 1].id 
              : chat.id;
              
            sendAdminReply(latestMessageId);
          });
          
          // Add event listener for Enter key in the textarea
          document.getElementById('chatReplyInput').addEventListener('keydown', function(e) {
            // Check if Enter is pressed without Shift
            if (e.key === 'Enter' && !e.shiftKey) {
              e.preventDefault(); // Prevent the default action (newline)
              // Get the ID of the latest message in the conversation
              const latestMessageId = messages.length > 0 
                ? messages[messages.length - 1].id 
                : chat.id;
                
              sendAdminReply(latestMessageId);
            }
          });
          
          // Scroll to the bottom of the messages
          const messagesContainer = document.getElementById('chatMessages');
          messagesContainer.scrollTop = messagesContainer.scrollHeight;
        })
        .catch(error => {
          console.error('Error fetching conversation:', error);
          chatDetail.innerHTML = `
            <div class="error-message">
              <p>Error loading conversation: ${error.message}</p>
              <button onclick="loadConversationDetail(chatData.find(c => c.id === '${chat.id}'))">Try Again</button>
            </div>
          `;
        });
    }
    
    // Toggle AI response visibility
    function toggleAiResponse(chatId) {
      if (!chatId) return;
      
      // Get the current chat
      const chat = chatData.find(c => c.id === chatId);
      if (!chat) return;
      
      // Toggle the hide_ai_response property
      chat.hide_ai_response = !chat.hide_ai_response;
      
      // Update the toggle button text
      const toggleButton = document.querySelector('.toggle-ai-button[data-id="' + chatId + '"]');
      if (toggleButton) {
        toggleButton.textContent = chat.hide_ai_response ? 'Show AI Response' : 'Hide AI Response';
      }
      
      // Update the chat display
      const aiMessageElement = document.querySelector('.chat-message.hidden-ai[data-id="' + chatId + '"]');
      if (aiMessageElement) {
        if (chat.hide_ai_response) {
          aiMessageElement.classList.remove('hidden-ai');
        } else {
          aiMessageElement.classList.add('hidden-ai');
        }
      } else if (!chat.hide_ai_response && chat.ai_response) {
        // AI message doesn't exist in the DOM but should be shown
        const userMessage = document.querySelector('.chat-message-user');
        if (userMessage) {
          const aiMessage = document.createElement('div');
          aiMessage.className = 'chat-message chat-message-ai hidden-ai';
          aiMessage.innerHTML = `
            ${chat.ai_response}
            <span class="chat-message-time">${formatDetailedTime(chat.created_at)}</span>
          `;
          userMessage.insertAdjacentElement('afterend', aiMessage);
        }
      }
      
      // Send the update to the server
      fetch(`/api/admin/support-chats/${chatId}/toggle-ai`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json'
        }
      })
      .then(response => response.json())
      .catch(error => {
        console.error('Error toggling AI response:', error);
      });
    }
    
    // Send Admin Reply
    async function sendAdminReply(chatId) {
      const replyInput = document.getElementById('chatReplyInput');
      const reply = replyInput.value.trim();
      
      if (!reply) {
        alert('Please enter a reply message');
        return;
      }
      
      try {
        const response = await fetch(`/api/admin/support-chats/${chatId}/respond`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ response: reply })
        });
        
        if (!response.ok) {
          throw new Error('Failed to send reply');
        }
        
        const data = await response.json();
        
        if (data.success) {
          // Clear input
          replyInput.value = '';
          
          // Add the message to the chat
          const messagesContainer = document.getElementById('chatMessages');
          const newMessage = document.createElement('div');
          newMessage.className = 'chat-message chat-message-admin';
          newMessage.innerHTML = `
            ${reply}
            <span class="chat-message-time">just now</span>
          `;
          messagesContainer.appendChild(newMessage);
          
          // Scroll to bottom
          messagesContainer.scrollTop = messagesContainer.scrollHeight;
          
          // If the status was pending, update it to responded
          if (data.chat.status === 'responded') {
            // Update status in UI
            document.querySelector('.chat-detail-status').textContent = 'Responded';
            document.querySelector('.chat-detail-status').className = 'chat-detail-status responded';
            
            // Update status buttons
            const statusButtons = document.querySelector('.chat-status-buttons');
            statusButtons.innerHTML = `
              <button class="status-button mark-resolved" data-status="resolved">Mark as Resolved</button>
            `;
            
            // Add event listener to new status button
            document.querySelector('.mark-resolved').addEventListener('click', function() {
              updateChatStatus(chatId, 'resolved');
            });
          }
          
          // Refresh chat list to show the updated status
          fetchSupportChats();
        } else {
          throw new Error(data.message || 'Failed to send reply');
        }
      } catch (error) {
        console.error('Error sending reply:', error);
        alert(`Error sending reply: ${error.message}`);
      }
    }
    
    // Update Chat Status
    async function updateChatStatus(chatId, status) {
      try {
        const response = await fetch(`/api/admin/support-chats/${chatId}/status`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ status })
        });
        
        if (!response.ok) {
          throw new Error('Failed to update status');
        }
        
        const data = await response.json();
        
        if (data.success) {
          // Update the status in our cached chat data
          const chatIndex = chatData.findIndex(c => c.id === chatId);
          if (chatIndex !== -1) {
            chatData[chatIndex].status = status;
          }
          
          // Update status in the dropdown
          const statusSelect = document.getElementById('statusSelect');
          if (statusSelect) {
            statusSelect.value = status;
          }
          
          // Update status in the sidebar chat list
          const chatItem = document.querySelector(`.chat-item[data-id="${chatId}"]`);
          if (chatItem) {
            // Remove all status classes
            chatItem.classList.remove('pending', 'responded', 'resolved', 'escalated');
            // Add the new status class
            chatItem.classList.add(status);
            
            // Update status text in the item
            const statusElement = chatItem.querySelector('.chat-item-status');
            if (statusElement) {
              statusElement.classList.remove('pending', 'responded', 'resolved', 'escalated');
              statusElement.classList.add(status);
              
              let statusText = status.charAt(0).toUpperCase() + status.slice(1);
              if (status === 'escalated') {
                statusText = '⚠️ Escalated';
              }
              statusElement.textContent = statusText;
            }
          }
          
          // If escalated, play a notification sound
          if (status === 'escalated') {
            playNotificationSound();
            showNotification('Chat has been escalated');
          }
          
          // Refresh the chat list to reflect the changes
          fetchSupportChats();
        } else {
          throw new Error(data.message || 'Failed to update status');
        }
      } catch (error) {
        console.error('Error updating status:', error);
        alert(`Error updating status: ${error.message}`);
      }
    }
    
    // Event listeners for search and filter
    document.getElementById('chatSearchInput').addEventListener('input', function(e) {
      currentSearch = e.target.value.trim();
      fetchSupportChats();
    });
    
    document.querySelectorAll('.chat-filter-button').forEach(button => {
      button.addEventListener('click', function() {
        // Remove active class from all buttons
        document.querySelectorAll('.chat-filter-button').forEach(btn => {
          btn.classList.remove('active');
        });
        
        // Add active class to clicked button
        this.classList.add('active');
        
        // Update current filter
        currentFilter = this.dataset.filter;
        
        // Fetch chats with new filter
        fetchSupportChats();
      });
    });
    
    // Start automatic refresh for the main chat list
    function startMainListRefresh() {
      // Clear any existing interval
      stopMainListRefresh();
      
      // Refresh chat list every 30 seconds
      mainListRefreshInterval = setInterval(() => {
        // Fetch the chat list silently in all cases
          fetchChatListSilently();
      }, 30000); // Every 30 seconds
    }
    
    // Stop the main list refresh
    function stopMainListRefresh() {
      if (mainListRefreshInterval) {
        clearInterval(mainListRefreshInterval);
        mainListRefreshInterval = null;
      }
    }
    
    // Fetch chat list in the background without disrupting the UI
    async function fetchChatListSilently() {
      try {
        let url = '/api/admin/support-chats';
        
        // Add search and filter
        const params = new URLSearchParams();
        if (currentSearch) {
          params.append('search', currentSearch);
        }
        
        // For silent fetches, always check for escalated chats
        params.append('status', 'escalated');
        
        if (params.toString()) {
          url += `?${params.toString()}`;
        }
        
        const response = await fetch(url);
        if (!response.ok) {
          throw new Error('Failed to fetch support chats');
        }
        
        const data = await response.json();
        if (data.success) {
          // Check if we have new escalated chats
          const escalatedChats = data.chats.filter(chat => chat.status === 'escalated');
          const oldEscalatedCount = newEscalatedCount;
          newEscalatedCount = escalatedChats.length;
          
          // Check if there are new escalated chats
          if (newEscalatedCount > oldEscalatedCount) {
            // Play notification sound
            playNotificationSound();
            
            // Add visual indicator in the sidebar
            updateSidebarNotification(newEscalatedCount);
            
            // If we're not currently on the escalated filter, show a notification
            if (currentFilter !== 'escalated') {
              showNotification(`${newEscalatedCount} escalated chats need attention`);
            }
            
            // Mark new escalated chats with unread indicator
            if (currentFilter === 'escalated') {
              escalatedChats.forEach(chat => {
                const chatItem = document.querySelector(`.chat-item[data-id="${chat.id}"]`);
                if (chatItem) {
                  chatItem.classList.add('unread');
                }
              });
            }
          }
          
          // Only update the UI if we're on the escalated filter
          if (currentFilter === 'escalated') {
            // Update chat count
            document.getElementById('chatCount').textContent = `${escalatedChats.length} chats`;
            
            // Update the chat list
            renderChatList(escalatedChats);
          }
        }
      } catch (error) {
        console.error('Error silently fetching support chats:', error);
      }
    }
    
    // Update sidebar notification indicator
    function updateSidebarNotification(count) {
      const supportNavItem = document.querySelector('.nav-item[data-section="support"]');
      
      // Remove existing badge if present
      const existingBadge = supportNavItem.querySelector('.notification-badge');
      if (existingBadge) {
        existingBadge.remove();
      }
      
      // Add new badge if count > 0
      if (count > 0) {
        const badge = document.createElement('span');
        badge.className = 'notification-badge';
        badge.textContent = count;
        supportNavItem.appendChild(badge);
      }
    }
    
    // Show a notification message
    function showNotification(message) {
      // Create notification element if it doesn't exist
      let notification = document.getElementById('notification');
      if (!notification) {
        notification = document.createElement('div');
        notification.id = 'notification';
        notification.className = 'notification';
        document.body.appendChild(notification);
      }
      
      // Set notification message and show it
      notification.textContent = message;
      notification.classList.add('show');
      
      // Hide after 5 seconds
      setTimeout(() => {
        notification.classList.remove('show');
      }, 5000);
    }

    // Start the auto-refresh when a chat is being viewed
    function startChatRefresh() {
        // Clear any existing interval first
        stopChatRefresh();
        
        // Start a new interval if we have a conversation ID
        if (currentConversationId) {
            chatRefreshInterval = setInterval(() => {
                refreshCurrentChat();
            }, 5000); // Refresh every 5 seconds
        }
    }

    // Stop the auto-refresh
    function stopChatRefresh() {
        if (chatRefreshInterval) {
            clearInterval(chatRefreshInterval);
            chatRefreshInterval = null;
        }
    }

    // Refresh the current chat
    function refreshCurrentChat() {
        if (!currentConversationId) return;
        
        // Show a subtle loading indicator
        const chatContainer = document.querySelector('#chatMessages');
      if (!chatContainer) return;
      
        const loadingIndicator = document.createElement('div');
        loadingIndicator.id = 'chatRefreshIndicator';
      loadingIndicator.innerHTML = '<div class="refresh-spinner"></div>';
        loadingIndicator.style.position = 'absolute';
        loadingIndicator.style.top = '10px';
        loadingIndicator.style.right = '10px';
        loadingIndicator.style.opacity = '0.5';
        
        // Remove any existing indicator
        const existingIndicator = document.querySelector('#chatRefreshIndicator');
        if (existingIndicator) {
            existingIndicator.remove();
        }
        
        chatContainer.appendChild(loadingIndicator);
        
        // Fetch the conversation
        fetch(`/api/admin/support-chats/conversation/${currentConversationId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Only update if we have new messages
                    const currentMessageCount = document.querySelectorAll('.chat-message').length;
                    if (data.messages.length > currentMessageCount / 2) { // Divide by 2 because we show user and AI as separate messages
              // If we were viewing a specific chat in detail, load the conversation again
              const chat = chatData.find(c => c.conversation_id === currentConversationId || c.id === currentConversationId);
              if (chat) {
                loadConversationDetail(chat);
              }
                    }
                }
                // Remove the loading indicator
                const indicator = document.querySelector('#chatRefreshIndicator');
                if (indicator) {
                    indicator.remove();
                }
            })
            .catch(error => {
                console.error('Error refreshing chat:', error);
                // Remove the loading indicator
                const indicator = document.querySelector('#chatRefreshIndicator');
                if (indicator) {
                    indicator.remove();
                }
            });
    }

    // Initialize notification sound
    function initNotificationSound() {
      try {
        notificationSound = new Audio('/static/sounds/notification.mp3');
        // Set preload attribute to auto
        notificationSound.preload = 'auto';
        
        // Add error handler to log issues
        notificationSound.addEventListener('error', function(e) {
          console.error('Notification sound error:', e);
          console.error('Audio error code:', notificationSound.error ? notificationSound.error.code : 'unknown');
          
          // Fallback to using a base64 encoded audio if loading from file fails
          initFallbackNotificationSound();
        });
        
        notificationSound.load();
        
        // Test preload to handle any browser security issues
        document.addEventListener('click', function triggerFirstInteraction() {
          notificationSound.volume = 0; // Mute it for the test
          notificationSound.play().then(() => {
            notificationSound.pause();
            notificationSound.currentTime = 0;
            notificationSound.volume = 1; // Reset volume
            console.log('Notification sound ready');
          }).catch(e => {
            console.warn('Could not preload notification sound:', e);
            // Try fallback if initial load fails
            initFallbackNotificationSound();
          });
          document.removeEventListener('click', triggerFirstInteraction);
        }, { once: true });
      } catch (e) {
        console.error('Error setting up notification sound:', e);
        initFallbackNotificationSound();
      }
    }

    // Initialize a fallback notification sound using a base64 encoded sound
    function initFallbackNotificationSound() {
      try {
        // Short base64 encoded notification beep
        const base64Sound = 'data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4Ljc2LjEwMAAAAAAAAAAAAAAA//tQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAASW5mbwAAAA8AAAAsAABfhQAFBxAPEhQXGRwfISMmKCssLzE0Nzo8P0FERkpMT1FUVllaXV9iZWdqbXBydXd6fH+BhIeMj5GUlpmbn6Klp6qsrrG0tbi7vcDBw8bIy83Q0tXX29/h4+bn6+3v8vT3+fz+AAAAAAAAAAAAAG5hbWUAAAAAAAAAAAAAAAAAAAAADVNvdW5kIFNhbXBsZQC0IwAAAA//tADAAAAmG2gXJYAAr9DvM/TY0nB3S6YHHNaIAt8hX70lQdQqJ1aZnfTrDNxAwYKcQ4Z9Jjn4vDQACdnRsULdWuOm/vOt00TGR3T99O9Tm3f7/9M+vfcOZ5r/VO58v+vN03ufdE+gx0v///gMj//tADAAACszzM8GCAAEPieX2YJIEQm+ZmUGJKA5YcnfmAwBkLvx+ZIMdHXf+pDQACb4vGCHCGCYAAxBWUKERnCnQUSZw2r0cLhIiFxgQQfVbNvSHH7cAu3VYN0BBl//HnvbB77+ufXnvrqA+//tADAAADIj7NoMGgBGKHeP4MggBJX3gZ+YAAxr7jy/MAQLzXXMX2eZrmQHsAACfnAKy45hYAAcYHbqEwCTgFDIFEGt4IOY6KYy4OqAK4e/ECBIP/6P/5gLUAc90/rHJfVm3/vUvJAUC//tADAAADF0BO4wwQAEEFuQmYFuUKLe/k3woACh3rzw/DAECKr3FJFkb51UIoAHgEKMDOGgAAINhmH34sADyAFuGlcnhCSQRoMUNgd08sM4cVGcVEUMB2WMr7/Oox4r4bSXrylZw//tADAAADG71J0MDLlGMGmMJBz5Aij3dXPCg0CJHupmPD4tB9OdeL9ZCPipzqAAB5xiYJ8MAAFK54oExlgAfQpqmZIYwIBuRIBE9ikcTh0nBDM1LVY7nrKXP4vDqcj6zU/0C4Q0d//tADAAADL7vc4MGhJGQGmE4xj9g4z3c3PBwoKLeK4PwY/QovX5gC3dU6LxoAB6hmcxYQgAG5EvOYQNgAFhEXNNGYAwyaDHnuGoBcQqJpUJA4YCx2K0kz+rvHMcSqpxDZdq5o5w+//tADAAADMz1HiMGgBGNfeL4MGOHZnrF3ng5VEL7GWPCgOSj9Slc7HrWzuluAAHLGDDFiCAA6YEcQGIAFSkTgVEG0gIB2SkJgRLY4WEh2rBmLQZ/R5wV9gS2ykPiPh7vVl3//tADAAADNrzTG3ZQXGRmeH4MAAMTPOK4MMcAUXcfwfg4KDWeaaNsxhpPxbsAA8IYiaKMABqxIrkM8QSIAcS0RUZQgGmg4GkxB7HMENvdJ/6JDzQYBpZV/d//+98f/5Qh//tADAAADJr1IFXb6oGvGaNiBjxBQnrF1gw4sEJ3FMzwYOBjf2fLl3Z1ORigAA5GIiOeKAAwCGQ8AVQI0AIYDxAoYFBZAPnWWHgzF3T6Lv/p4OIWK/sIe/9jFxfEiC5hcU3d//tADAAADPbkJBPYYHKZ+5a4MFLA0/xcIMaOLGuKEHwYAcFduPP9W7DQ+9gAD2CxCPCAAYAQAFfINQAUqmLKAGAJPFVLpZKBmKW/6rCAGDX/LwD/s/+Xy4fk7OuJ/KFzT//tADAAADRMDLbBgwAGUfeEvBgpIMH3E8HwQYTHeOKPwQACS/Zc/VHoYcggADkDADBCAAgJIqyAUCggLIFRCOiCwlkdx/8kAwaH/bUABSf/7gPk/h1g1+u/9z6xZVT//tADAAADPDsIhBgwAGHnxAPwYUUBheYZgwY4gHXGL4cETGhd2MJ+vdXOKVQAeQYIYQQAAgATNNjGUoJAsC4m0skDJ6kFXHAVPRpf5gPh//YEfKkPMbvf//hynlHq4//tADAAADLLlJhNDQRGGneJIMEZgxMeF8MGFgxPeEdBhR5EUdmTPt0MZCYgAdoKIaIQAAACgZ5oY0gHUSH3fOZaKkmJXUDvQF/9ABCP/zn/sAGTAO+xH7/ef+Dv/kBQ//tADAAADLjlIBBgYACH3zAPwYYiKmvEBgwwgcFPGEH4QKBLPMhP9RFg1gADzBoiggABKRCVpFYGZbBhwICZyxvwEH+QAgn/zgf9wAyYBEP//oc6/9zG///BjQAAA';
        
        notificationSound = new Audio(base64Sound);
        notificationSound.preload = 'auto';
        notificationSound.load();
        console.log('Fallback notification sound initialized');
      } catch (e) {
        console.error('Fallback notification sound initialization failed:', e);
      }
    }

    // Play notification sound with retry mechanism
    function playNotificationSound() {
      if (!notificationSound) {
        console.warn('Notification sound not initialized');
        return;
      }
      
      // Reset sound to beginning
      notificationSound.currentTime = 0;
      
      // Try to play with fallback
      const playPromise = notificationSound.play();
      if (playPromise !== undefined) {
        playPromise
          .then(() => console.log('Notification sound played successfully'))
          .catch(error => {
            console.warn('Error playing notification sound:', error);
          });
      }
    }
    
    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      checkAuth();
      displayCurrentDate();
      initNotificationSound();
      
      // Default to showing escalated chats
      currentFilter = 'escalated';
      document.querySelectorAll('.chat-filter-button').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.filter === 'escalated') {
          btn.classList.add('active');
        }
      });
      
      fetchSupportChats().then(() => {
        // After loading chats, check if we have a chat ID in the URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const chatId = urlParams.get('id');
        
        if (chatId) {
          // Find the chat with this ID
          const selectedChat = chatData.find(chat => chat.id === chatId);
          if (selectedChat) {
            // Set as current chat
            currentChatId = chatId;
            if (selectedChat.conversation_id) {
              currentConversationId = selectedChat.conversation_id;
            }
            
            // Select in the UI
            const chatItem = document.querySelector(`.chat-item[data-id="${chatId}"]`);
            if (chatItem) {
              // Remove active class from all items
              document.querySelectorAll('.chat-item').forEach(item => {
                item.classList.remove('active');
              });
              
              // Add active class to this item
              chatItem.classList.add('active');
              
              // Remove unread indicator if present
              chatItem.classList.remove('unread');
            }
            
            // Load chat detail - if we have a conversation_id, load the full conversation
            if (selectedChat.conversation_id) {
              loadConversationDetail(selectedChat);
            } else {
              loadChatDetail(selectedChat);
            }
            
            // Start chat refresh if needed
            if (selectedChat.conversation_id) {
              startChatRefresh();
            }
          }
        }
      });
      
      startMainListRefresh();
    });

    // Handle page visibility changes
    document.addEventListener('visibilitychange', function() {
      if (document.visibilityState === 'visible') {
        // Resume refreshing for both main list and current chat
        startMainListRefresh();
        if (currentConversationId) {
          startChatRefresh();
        }
        
        // Immediately fetch new chats
        fetchSupportChats();
      } else {
        // Pause all refreshing when tab is not visible
        stopMainListRefresh();
        stopChatRefresh();
      }
    });

    // Clean up when navigating away
    window.addEventListener('beforeunload', function() {
      stopMainListRefresh();
      stopChatRefresh();
    });

    // HTML escape function to prevent XSS
    function escapeHtml(html) {
      if (!html) return '';
      
      const div = document.createElement('div');
      div.textContent = html;
      return div.innerHTML;
    }
  </script>
</body>
</html>